-- SHOW_AUTO

CREATE OR REPLACE FUNCTION SHOW_AUTO_RZESZOW
  RETURN SYS_REFCURSOR
AS
  MY_CURSOR SYS_REFCURSOR;
  MY_QUERY VARCHAR(40);
BEGIN
  OPEN MY_CURSOR FOR SELECT A.nr_vin,A.marka,A.model,A.kolor,A.rok,to_char(A.ubezpieczenie,'YY/MM/DD')Ubezpieczenie,to_char(A.przeglad,'YY/MM/DD')Przeglad,K.klasa,A.stan,A.cena 
  FROM AUTO A , KATALOG K
  WHERE k.id_katalog = a.id_katalog AND k.id_wypozyczalnia = 1;
  RETURN MY_CURSOR;
END SHOW_AUTO_RZESZOW;
/

CREATE OR REPLACE FUNCTION SHOW_AUTO_KRAKOW
  RETURN SYS_REFCURSOR
AS
  MY_CURSOR SYS_REFCURSOR;
  MY_QUERY VARCHAR(40);
BEGIN
  OPEN MY_CURSOR FOR SELECT A.nr_vin,A.marka,A.model,A.kolor,A.rok,to_char(A.ubezpieczenie,'YY/MM/DD')Ubezpieczenie,to_char(A.przeglad,'YY/MM/DD')Przeglad,K.klasa,A.stan,A.cena 
  FROM AUTO A , KATALOG K
  WHERE k.id_katalog = a.id_katalog AND k.id_wypozyczalnia = 2;
  RETURN MY_CURSOR;
END SHOW_AUTO_KRAKOW;
/

CREATE OR REPLACE FUNCTION SHOW_AUTO_WARSZAWA
  RETURN SYS_REFCURSOR
AS
  MY_CURSOR SYS_REFCURSOR;
  MY_QUERY VARCHAR(40);
BEGIN
  OPEN MY_CURSOR FOR SELECT A.nr_vin,A.marka,A.model,A.kolor,A.rok,to_char(A.ubezpieczenie,'YY/MM/DD')Ubezpieczenie,to_char(A.przeglad,'YY/MM/DD')Przeglad,K.klasa,A.stan,A.cena 
  FROM AUTO A , KATALOG K
  WHERE k.id_katalog = a.id_katalog AND k.id_wypozyczalnia = 3;
  RETURN MY_CURSOR;
END SHOW_AUTO_WARSZAWA;
/

-- SHOW_KLIENT

CREATE OR REPLACE FUNCTION SHOW_KLIENT
  RETURN SYS_REFCURSOR
AS
  MY_CURSOR SYS_REFCURSOR;
BEGIN
  OPEN MY_CURSOR FOR SELECT * FROM KLIENT;
  RETURN MY_CURSOR;
END SHOW_KLIENT;
/

-- SHOW WYPOZYCZENIE
-- RZESZÓW

CREATE OR REPLACE FUNCTION SHOW_WYPOZYCZENIE_ZWR_RZESZOW
  RETURN SYS_REFCURSOR
AS
  MY_CURSOR SYS_REFCURSOR;
  MY_QUERY VARCHAR(40);
BEGIN
  OPEN MY_CURSOR FOR SELECT W.ID_WYPOZYCZENIE, W.ID_KLIENT, W.NR_VIN, A.MARKA, A.MODEL,W.ID_PRACOWNIK_WYP, W.ID_PRACOWNIK_ZWR,to_char(W.DATA_WYP,'YY/MM/DD')WYPOZYCZENIE,to_char(W.DATA_ZWR,'YY/MM/DD')ZWROT, W.KOSZT 
  FROM WYPOZYCZENIE W, AUTO A, KLIENT K, WYPOZYCZALNIA WA 
  WHERE W.ID_WYPOZYCZALNIA = WA.ID_WYPOZYCZALNIA AND W.NR_VIN = A.NR_VIN AND W.ID_KLIENT = K.ID_KLIENT AND W.ID_WYPOZYCZALNIA = 1 AND W.DATA_ZWR IS NOT NULL;
  RETURN MY_CURSOR;
END SHOW_WYPOZYCZENIE_ZWR_RZESZOW;
/

CREATE OR REPLACE FUNCTION SHOW_WYPOZYCZENIE_WYP_RZESZOW
  RETURN SYS_REFCURSOR
AS
  MY_CURSOR SYS_REFCURSOR;
  MY_QUERY VARCHAR(40);
BEGIN
  OPEN MY_CURSOR FOR SELECT W.ID_WYPOZYCZENIE, W.ID_KLIENT, W.NR_VIN, A.MARKA, A.MODEL,W.ID_PRACOWNIK_WYP,to_char(W.DATA_WYP,'YY/MM/DD')WYPOZYCZENIE
  FROM WYPOZYCZENIE W, AUTO A, KLIENT K, WYPOZYCZALNIA WA 
  WHERE W.ID_WYPOZYCZALNIA = WA.ID_WYPOZYCZALNIA AND W.NR_VIN = A.NR_VIN AND W.ID_KLIENT = K.ID_KLIENT AND W.ID_WYPOZYCZALNIA = 1 AND W.DATA_ZWR IS NULL;
  RETURN MY_CURSOR;
END SHOW_WYPOZYCZENIE_WYP_RZESZOW;
/

-- KRAKÓW

CREATE OR REPLACE FUNCTION SHOW_WYPOZYCZENIE_ZWR_KRAKOW
  RETURN SYS_REFCURSOR
AS
  MY_CURSOR SYS_REFCURSOR;
  MY_QUERY VARCHAR(40);
BEGIN
  OPEN MY_CURSOR FOR SELECT W.ID_WYPOZYCZENIE, W.ID_KLIENT, W.NR_VIN, A.MARKA, A.MODEL,W.ID_PRACOWNIK_WYP, W.ID_PRACOWNIK_ZWR,to_char(W.DATA_WYP,'YY/MM/DD')WYPOZYCZENIE,to_char(W.DATA_ZWR,'YY/MM/DD')ZWROT, W.KOSZT 
  FROM WYPOZYCZENIE W, AUTO A, KLIENT K, WYPOZYCZALNIA WA 
  WHERE W.ID_WYPOZYCZALNIA = WA.ID_WYPOZYCZALNIA AND W.NR_VIN = A.NR_VIN AND W.ID_KLIENT = K.ID_KLIENT AND W.ID_WYPOZYCZALNIA = 2 AND W.DATA_ZWR IS NOT NULL;
  RETURN MY_CURSOR;
END SHOW_WYPOZYCZENIE_ZWR_KRAKOW;
/

CREATE OR REPLACE FUNCTION SHOW_WYPOZYCZENIE_WYP_KRAKOW
  RETURN SYS_REFCURSOR
AS
  MY_CURSOR SYS_REFCURSOR;
  MY_QUERY VARCHAR(40);
BEGIN
  OPEN MY_CURSOR FOR SELECT W.ID_WYPOZYCZENIE, W.ID_KLIENT, W.NR_VIN, A.MARKA, A.MODEL,W.ID_PRACOWNIK_WYP,to_char(W.DATA_WYP,'YY/MM/DD')WYPOZYCZENIE
  FROM WYPOZYCZENIE W, AUTO A, KLIENT K, WYPOZYCZALNIA WA 
  WHERE W.ID_WYPOZYCZALNIA = WA.ID_WYPOZYCZALNIA AND W.NR_VIN = A.NR_VIN AND W.ID_KLIENT = K.ID_KLIENT AND W.ID_WYPOZYCZALNIA = 2 AND W.DATA_ZWR IS NULL;
  RETURN MY_CURSOR;
END SHOW_WYPOZYCZENIE_WYP_KRAKOW;
/

-- WARSZAWA

CREATE OR REPLACE FUNCTION SHOW_WYPOZYCZENIE_ZWR_WARSZAWA
  RETURN SYS_REFCURSOR
AS
  MY_CURSOR SYS_REFCURSOR;
  MY_QUERY VARCHAR(40);
BEGIN
  OPEN MY_CURSOR FOR SELECT W.ID_WYPOZYCZENIE, W.ID_KLIENT, W.NR_VIN, A.MARKA, A.MODEL,W.ID_PRACOWNIK_WYP, W.ID_PRACOWNIK_ZWR,to_char(W.DATA_WYP,'YY/MM/DD')WYPOZYCZENIE,to_char(W.DATA_ZWR,'YY/MM/DD')ZWROT, W.KOSZT 
  FROM WYPOZYCZENIE W, AUTO A, KLIENT K, WYPOZYCZALNIA WA 
  WHERE W.ID_WYPOZYCZALNIA = WA.ID_WYPOZYCZALNIA AND W.NR_VIN = A.NR_VIN AND W.ID_KLIENT = K.ID_KLIENT AND W.ID_WYPOZYCZALNIA = 3 AND W.DATA_ZWR IS NOT NULL;
  RETURN MY_CURSOR;
END SHOW_WYPOZYCZENIE_ZWR_WARSZAWA;
/

CREATE OR REPLACE FUNCTION SHOW_WYPOZYCZENIE_WYP_WARSZAWA
  RETURN SYS_REFCURSOR
AS
  MY_CURSOR SYS_REFCURSOR;
  MY_QUERY VARCHAR(40);
BEGIN
  OPEN MY_CURSOR FOR SELECT W.ID_WYPOZYCZENIE, W.ID_KLIENT, W.NR_VIN, A.MARKA, A.MODEL,W.ID_PRACOWNIK_WYP,to_char(W.DATA_WYP,'YY/MM/DD')WYPOZYCZENIE
  FROM WYPOZYCZENIE W, AUTO A, KLIENT K, WYPOZYCZALNIA WA 
  WHERE W.ID_WYPOZYCZALNIA = WA.ID_WYPOZYCZALNIA AND W.NR_VIN = A.NR_VIN AND W.ID_KLIENT = K.ID_KLIENT AND W.ID_WYPOZYCZALNIA = 3 AND W.DATA_ZWR IS NULL;
  RETURN MY_CURSOR;
END SHOW_WYPOZYCZENIE_WYP_WARSZAWA;
/

-- OBLICZANIE CENY

  CREATE OR REPLACE FUNCTION CENA_WYPOZYCZENIE(vin NUMBER, ile_dni NUMBER)
  RETURN NUMBER
AS
  SZUKANA_WARTOSC NUMBER;
BEGIN

  SELECT (CENA * ile_dni) INTO SZUKANA_WARTOSC FROM AUTO WHERE NR_VIN = vin;
  RETURN SZUKANA_WARTOSC;

END CENA_WYPOZYCZENIE;
/



CREATE OR REPLACE FUNCTION CENA_ZWROT(id_wyp NUMBER)
RETURN NUMBER
AS
  SZUKANA_WARTOSC NUMBER;
  REK_WYP WYPOZYCZENIE%ROWTYPE;
  REK_AUTO AUTO%ROWTYPE;
  ILE_DNI NUMBER; 
BEGIN
  SELECT nr_vin, data_wyp INTO rek_wyp.nr_vin, rek_wyp.data_wyp FROM wypozyczenie WHERE id_wypozyczenie = id_wyp;
  SELECT cena INTO rek_auto.cena FROM auto WHERE nr_vin = rek_wyp.nr_vin;
  ile_dni := TO_NUMBER(TRUNC(SYSDATE-rek_wyp.data_wyp));
  
  SELECT (ile_dni * rek_auto.cena) INTO SZUKANA_WARTOSC FROM AUTO WHERE NR_VIN = rek_wyp.nr_vin;
  RETURN SZUKANA_WARTOSC;
END CENA_ZWROT;
/